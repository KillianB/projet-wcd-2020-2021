<!DOCTYPE html>
<html id="PAGE" lang="fr">
<head>
    <meta charset="UTF-8">
    <title>TinyInsta</title>

    <!-- Google login -->
    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="1048463456874-56t3t922794hiac34phbfntkdqmt0lhl.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <!-- Google login -->

    <!-- Mithril -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
    <script defer
            src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <script src="https://unpkg.com/mithril/mithril.js"></script>
    <!-- Mithril -->

</head>
<body>
<script>

    // TODO: Follow + Unfollow
    class User {
        constructor(user) {
            this.name = user.name
            this.url = user.url
        }

        view() {
            return m('div', {class:'container block box'}, [
                m('article', {class:'media'}, [
                    m('div', {class:'media-left'}, [
                        m('figure', {class:'image is-32x32'}, [
                            m('img', {src:this.url})
                        ])
                    ]),
                    m('div', {class:'media-content'}, [
                        m('div', {class:'content'}, [
                            m('p', {class:'is-size-4 is-centered', style:'margin-top: auto; margin-bottom:auto'}, this.name)
                        ])
                    ]),
                    m('div', {class:'media-right'}, [
                        m('button', {class:'button is-info', onclick:''}, 'Follow')
                    ])
                ])
            ])
        }
    }

    // Done
    class Notification {
        constructor(message, type) {
            this.message = message;
            this.type = type;
        }

        view() {
            return m('div', {class:"notification is-light" + this.type, style:'position:fixed; right: 10px; bottom: 10px' }, [
                m('button', {
                    class:'delete',
                    onclick: function() {
                        Profile.notifications = []
                    }
                }),
                m('p', {class:'text'}, this.message)
            ]);
        }
    }

    // TODO: Like + Modal
    class Message {
        constructor(key, sender, urlProfil, urlImage, content, nbLike) {
            this.key = key;
            this.name = sender;
            this.urlProfil = urlProfil;
            this.urlImage = urlImage;
            this.content = content;
            this.nbLike = nbLike;
        }

        view() {
            return m('div', {class:'container box block'}, [
                m('article', {class:'media'}, [
                    m('figure', {class:'media-left'}, [
                        m('img', {src:this.urlProfil, class:'image is-64x64', style:'border-radius:50%'})
                    ]),
                    m('div', {class:'media-content'}, [
                        m('div', {class:'field'}, [
                            m('p', {class:'control'}, [
                                m('a', {onclick:''}, [
                                    m('strong', this.name)
                                ]),
                                m('br'),
                                m('p', this.content)
                            ])
                        ]),
                        m('div', {class:'field'}, [
                            m('img', {src:this.urlImage, class:'image'})
                        ]),
                        m('nav', {class:'level'}, [
                            m('div', {class:'level-left'}, [
                                m('p', {style:'margin-top:auto; margin-bottom:auto; margin-right:5px; font-size:15px'}, this.nbLike),
                                m('a', {class:'level-item', onclick:this.like, style:'margin-top:auto; margin-bottom:auto'}, [
                                    m('span', {class:'icon is-small'}, [
                                        m('i', {class:'fas fa-heart'})
                                    ])
                                ])
                            ])
                        ])
                    ])
                ])
            ])
        }

        like() {
        }
    }

    // TODO: Like + Follow + Unfollow
    let Profile={

        // Attributs
        name:"",
        email:"",
        ID:"",
        url:"",
        // Used for the Timeline
        nextMessageToken:"",
        // Container of notification
        notifications: [],

        // Fonctions
        view: function(){
            return m('secion', {class:'hero is-light is-fullheight',  id:"PAGE"}, [
                // Page body
                m('div', {class:'hero-body'}, [
                    m('div', {class:'container', style:'top:20px'}, [
                        m(TimeLine)
                    ])
                ]),
                // Pop-ups
                m('div', [
                    // Notifications
                    m('div', Profile.notifications),
                    m(Modal)
                ]),
                // Header
                m('div', {class:'hero-head has-background-light', style:'position:fixed; width:100%'}, [
                    m('header', {class:'navbar'}, [
                        m('div', {class:'container'}, [
                            m('div', {class:'navbar-brand'}, [

                                // Title
                                m('h1', {class:'navbar-item title', style:'margin-top:auto; margin-bottom:auto'}, "TinyInsta"),

                                // Profil image
                                m('img', {
                                    src:Profile.url,
                                    class:'navbar-item image is-64x64',
                                    style:'border-radius:50%; margin-top:auto; margin-bottom:auto'
                                }),

                                // Profil name
                                m('h1', {class: 'navbar-item title', style:'margin-top:auto; margin-bottom:auto'}, Profile.name),

                                // Follows
                                m('a', {
                                    class: 'navbar-item subtitle',
                                    style:'margin-top:auto; margin-bottom:auto',
                                    onclick:function () {
                                        Modal.open(Profile.name, Profile.url, "Follows", "followers")
                                    }
                                }, "Follows"),

                                // Followers
                                m('a', {
                                    class: 'navbar-item subtitle',
                                    style:'margin-top:auto; margin-bottom:auto',
                                    onclick:function () {
                                        Modal.open(Profile.name, Profile.url, "Followers", "followed")
                                    }
                                }, "Followers")
                            ])
                        ])
                    ])
                ])
            ])
        },
        postMessage: function(content, image) {
            // On montre à l'utilisateur que l'on envoi le message
            PostMessageButton.loading();

            let res = undefined;
            if (PostMessage.content === "" && PostMessage.image === "") {
                Profile.dangerNotification("Au moins un champ doit contenir quelque chose !");
            }
            else {
                // On fait la requête
                let data = {
                    url: image,
                    body: content,
                    sender: Profile.name
                }
                res = m.request({
                    method: "POST",
                    url: "_ah/api/tinyApi/v1/postMessage"+'?access_token='+encodeURIComponent(Profile.ID),
                    params: data
                })
                    .then(function(result) {
                        console.log("post_message: ", result);

                        // On vide le contenu de la fenêtre pour confirmer à l'utilisateur que l'envoi a bien été effectué
                        PostMessage.content = "";
                        document.getElementById("PostContent").value = "";
                        PostMessage.image = "";
                        document.getElementById("PostImage").value = "";
                    })

                if (!(PostMessage.content === "")) {
                    Profile.dangerNotification("Une erreur s'est produite lors de l'envois");
                }
            }

            // On termine l'envoi du messages
            PostMessageButton.unloading();

            return res;
        },
        next: function() {
            // On montre à l'utilisateur que l'on charge les nouveaux messages
            TimeLineButton.loading();

            let items = [];

            // On fait la requête
            let res = m.request({
                method: "GET",
                url: "_ah/api/tinyApi/v1/collectionresponse_post/" + Profile.name,
                params: {
                    'cursorString':Profile.nextMessageToken,
                    'access_token': encodeURIComponent(Profile.ID)
                }
            })
                .then(function(result) {
                    console.log("next:", result);

                    items = result.items;
                    TimeLine.updateMessage(items);
                    if ('nextPageToken' in result) { Profile.nextMessageToken= result.nextPageToken }
                    else { Profile.nextMessageToken="" }
                })

            if (items === []) {
                Profile.dangerNotification("Une erreur s'est produite lors de la réception");
            }

            // On termine la mise en chargement des messages
            TimeLineButton.unloading();

            // On retourne le résultat de la requête
            return res;
        },
        follow: function(target) {
            let data = {
                user: Profile.name,
                target: target
            }
            return m.request({
                method: "POST",
                url: "_ah/api/tinyApi/v1/follow"+'?access_token='+encodeURIComponent(Profile.ID),
                params: data
            })
                .then(function(result) {
                    console.log("follow: ", result);
                })
        },
        like: function(message) {
            let data = {
                keyString:message.key
            }
            return m.request({
                method: "POST",
                url: "_ah/api/tinyApi/v1/follow"+'?access_token='+encodeURIComponent(Profile.ID),
                params: data
            })
                .then(function(result) {
                    console.log("like: ", result);
                })
        },
        dangerNotification: function(message) {
            let notification = new Notification(message, 'is-danger');
            Profile.notifications = [m(notification)];
        }
    }

    // TODO: Follow + Unfollow + Fix la requête dans loadFollows une fois l'api rectifiée
    let Modal = {
        name: "",
        url: "",
        title: "",
        follows:[ // Valeurs exemples. Initialisé vide quand tout sera fonctionnel
            m(new User({name:"Killian BARREAU", url:""})),
            m(new User({name:"Alexandre DESMONTILS", url:""})),
            m(new User({name:"Un deux plus", url:""})),
            m(new User({name:"Deux de plus", url:""})),
            m(new User({name:"Killian BARREAU", url:""})),
            m(new User({name:"Alexandre DESMONTILS", url:""})),
            m(new User({name:"Un deux plus", url:""})),
            m(new User({name:"Deux de plus", url:""})),
            m(new User({name:"Killian BARREAU", url:""})),
            m(new User({name:"Alexandre DESMONTILS", url:""})),
            m(new User({name:"Un deux plus", url:""})),
            m(new User({name:"Deux de plus", url:""}))
        ],
        nextTokenFollows:"",
        view: function() {
            return m('div', {class:'modal', id:'Modal'}, [
                // Shadow background
                m('div', {class:'modal-background', onclick: Modal.exit}),

                // Card
                m('div', {class:'modal-card'}, [

                    // Header
                    m('header', {class:'modal-card-head'}, [
                        m('div', {class:'modal-card-title'}, [
                            m('nav', {class:'level'}, [
                                m('div', {class:'level-left'}, [
                                    m('img', {
                                        src:Modal.url,
                                        class:'level-item image is-64x64',
                                        style:'border-radius: 50%; margin-top: auto; margin-bottom: auto'
                                    }),
                                    m('p', {
                                        class:'level-item',
                                        style:'margin-top: auto; margin-bottom: auto'
                                    }, Modal.name + " - " + Modal.title),
                                ])
                            ])
                        ]),
                        m('button', {class:'delete is-large', 'aria-label':'close', onclick: Modal.exit})
                    ]),

                    // Body
                    m('section', {class:'modal-card-body has-background-grey-light'}, Modal.follows),

                    // Footer
                    m('footer', {class:'modal-card-foot'}, [
                        m('button', {class:'button is-info', onclick:''}, 'Afficher plus')
                    ])
                ])
            ])
        },
        exit: function() {
            document.getElementById('Modal').classList.remove('is-active')
            document.getElementById('PAGE').classList.remove('is-clipped')
        },
        open: function(nameUser, urlProfil, title, request) {
            Modal.name = nameUser;
            Modal.url = urlProfil;
            Modal.title = title;
            /*
            Modal.follows = [];
            Modal.nextTokenFollows = "";
             */

            document.getElementById('Modal').classList.add('is-active')
            document.getElementById('PAGE').classList.add('is-clipped')

            if (request === "followers" || request === "followed") {
                // Modal.loadFollows(request)
            }
        },
        loadFollows: function(version) {
            let data = {
                user:Modal.name,
                next:Modal.nextTokenFollows
            }
            let res = m.request({
                method: "GET",
                url: "_ah/api/tinyApi/v1/" + version + 'List/' + Modal.name + '?access_token='+encodeURIComponent(Profile.ID),
                params: data
            })
                .then(function(result) {
                    console.log(version + ": " + result)
                    console.log('items: ' + result.items);

                    if (result.items.length === 0) {
                        Profile.dangerNotification("Tout est déjà affiché")
                    }
                    else {
                        result.items.forEach(function(item) {
                            let user = new User(item)
                            console.log(item.name);
                            Modal.follows.push(m(user))
                        })
                    }
                    Modal.nextTokenFollows = result.nextPageToken
                })

            return res;
        }
    }

    // Done
    function onSignIn(googleUser) {
        let profile = googleUser.getBasicProfile();

        Profile.ID=googleUser.getAuthResponse().id_token;
        Profile.name=profile.getName();
        Profile.email=profile.getEmail();
        Profile.url=profile.getImageUrl();

        m.route.set('/secret');
    }

    // Done
    let Login = {
        view: function() {
            return m('secion', {class:'hero is-light is-fullheight'}, [
                m('div', {class:'hero-head'}, [
                    m('header', {class:'navbar'}, [
                        m('div', {class:'container'}, [
                            m('div', {class:'navbar-brand'}, [
                                m('h1', {class:'navbar-item title', style:'margin-top:auto; margin-bottom:auto'}, "TinyInsta"),
                                m('div', {
                                    class:'navbar-item g-signin2',
                                    style:'margin-top:auto; margin-bottom:auto',
                                    'data-theme':'dark',
                                    'data-onsuccess':'onSignIn'
                                })
                            ])
                        ])
                    ])
                ]),
                m('div', {class:'hero-body'}, [
                    m('div', {class:'container has-text-centered'}, [
                        m('h1', {class:'title', style:'width:50%; margin-left:auto; margin-right:auto'},
                            "Pour utiliser TinyInsta il est nécessaire de se connecter avec son compte Google")
                    ])
                ])
            ])
        }
    }

    // Done
    let PostMessageButton = {
        view: function () {
            return m('nav', {class:'level'}, [
                m('div', {class:'level-left'}, [
                    m('div', {class:'level-item'}, [
                        m('a', {id:'PostMessageButton', class:'button is-info is-light', onclick:PostMessage.postMessage}, 'Envoyer')
                    ])
                ])
            ])
        },
        loading: function () {
            document.getElementById('PostMessageButton').classList.add('is-loading');
        },
        unloading: function () {
            document.getElementById('PostMessageButton').classList.remove('is-loading');
        }
    }

    // Done
    let PostMessage = {
        content:"",
        image:"",
        view: function() {
            return m('div', {class:'container box block'}, [
                m('article', {class:'media'}, [
                    m('div', {class:'media-content'}, [
                        m('form', {name:'f'}, [
                            m('div', {class:'field'}, [
                                m('p', {class:'control'}, [
                                    m('textarea', {
                                        id:"PostContent",
                                        class:'textarea',
                                        placeholder:'Écrire un message',
                                        oninput: PostMessage.updateContent,
                                        value: PostMessage.content
                                    })
                                ])
                            ]),
                            m('div', {class:'field'}, [
                                m('p', {class:'control'}, [
                                    m('input', {
                                        id:"PostImage",
                                        class:'input',
                                        type:'text',
                                        placeholder:'URL image',
                                        oninput: PostMessage.updateImage,
                                        value: PostMessage.image})
                                ])
                            ]),
                            m(PostMessageButton)
                        ])
                    ])
                ])
            ])
        },
        updateContent: function (text) {
            PostMessage.content = text.target.value;
        },
        updateImage: function (url) {
            PostMessage.image = url.target.value;
        },
        postMessage: function() {
            Profile.postMessage(PostMessage.content, PostMessage.image);
        }
    }

    // Done
    let TimeLineButton = {
        view: function() {
            return m('div', {class:'block'},
                m('button', {id:'TimeLineButton', class:'button is-info is-outlined', onclick:Profile.next}, "Afficher plus de messages")
            )
        },
        loading: function() {
            document.getElementById('TimeLineButton').classList.add('is-loading');
        },
        unloading: function () {
            document.getElementById('TimeLineButton').classList.remove('is-loading');
        }
    }

    // Done
    let TimeLine = {
        buttonClass: "button is-info is-outlined",
        listItems:[m(PostMessage)],
        view: function() {
            return m('div', [
                m('div', {class:'block'}, TimeLine.listItems),
                m(TimeLineButton)
            ])
        },
        updateMessage: function(items) {
            for (let i in items) {
                console.log(items[i]);
                TimeLine.listItems.push(m(new Message("key", items[i].sender, "", items[i].url, items[i].body, 42)));
            }
        }
    }

    // Done
    m.route(document.body, "/secret", {
        "/secret": { onmatch: function() {
                if (Profile.ID==="") {m.route.set("/login")}
                else return Profile
            }},
        "/login": Login
    })

</script>
</body>
</html>


