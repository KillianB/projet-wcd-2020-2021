<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>TinyInsta</title>

    <!-- Google login -->
    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="775716886641-vsqe5q215v0t2a6pei7qniub9593rb1g.apps.googleusercontent.com">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <!-- Google login -->

    <!-- Mithril -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.0/css/bulma.min.css">
    <script defer
            src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <script src="https://unpkg.com/mithril/mithril.js"></script>
    <!-- Mithril -->

</head>
<body>
<script>

    let Profile={

        // Attributs
        name:"",
        email:"",
        ID:"",
        url:"",
        nextToken:"",
        list:[],

        // Fonctions
        view: function(){
            return m('secion', {class:'hero is-light is-fullheight'}, [
                m('div', {class:'hero-body'}, [
                    m('div', {class:'container', style:'top:20px'}, [
                        m(TimeLine)
                    ])
                ]),
                m('div', {class:'hero-head has-background-light', style:'position:fixed; width:100%'}, [
                    m('header', {class:'navbar'}, [
                        m('div', {class:'container'}, [
                            m('div', {class:'navbar-brand'}, [
                                m('h1', {class:'navbar-item title', style:'margin-top:auto; margin-bottom:auto'}, "TinyInsta"),
                                m("img", {
                                    src:Profile.url,
                                    class:'navbar-item image is-64x64',
                                    style:'border-radius:50%; margin-top:auto; margin-bottom:auto'
                                }),
                                m("h1", {class: 'navbar-item title', style:'margin-top:auto; margin-bottom:auto'}, Profile.name)
                            ])
                        ])
                    ])
                ])
            ])
        },
        postMessage: function(content, image) {
            let data={
                'url': image,
                'body': content,
                'sender': Profile.ID
            }
            return m.request({
                method: "POST",
                url: "_ah/api/tinyApi/v1/postMessage"+'?access_token='+encodeURIComponent(Profile.ID),
                params: data
            })
                .then(function(result) {
                    console.log("post_message: ",result);
                })
        },
        loadList: function() {
            return m.request({
                method: "GET",
                url: "_ah/api/tinyApi/v1/collectionresponse_entity"+'?access_token=' + encodeURIComponent(Profile.ID)
            })
                .then(function(result) {
                    console.log("load_list:",result)
                    Profile.list=result.items
                    if ('nextPageToken' in result) {
                        Profile.nextToken= result.nextPageToken
                    } else {
                        Profile.nextToken=""
                    }})
        },
        next: function() {
            return m.request({
                method: "GET",
                url: "_ah/api/myApi/v1/collectionresponse_entity",
                params: {
                    'next':Profile.nextToken,
                    'access_token': encodeURIComponent(Profile.ID)
                }
            })
                .then(function(result) {
                    console.log("next:",result)
                    result.items.map(function(item){Profile.list.push(item)})
                    if ('nextPageToken' in result) {
                        Profile.nextToken= result.nextPageToken
                    } else {
                        Profile.nextToken=""
                    }})
        },
        follow: function(user) {
            let data = {
                "user": Profile.ID,
                "target": user
            }
            return m.request({
                method: "POST",
                url: "_ah/api/tinyApi/v1/follow"+'?access_token='+encodeURIComponent(Profile.ID),
                params: data
            })
                .then(function(result) {
                    console.log("follow: ",result);
                })
        }
    }

    function onSignIn(googleUser) {
        let profile = googleUser.getBasicProfile();

        Profile.ID=googleUser.getAuthResponse().id_token;
        Profile.name=profile.getName();
        Profile.email=profile.getEmail();
        Profile.url=profile.getImageUrl();

        m.route.set('/secret');
    }

    let Login = {
        view: function() {
            return m('secion', {class:'hero is-light is-fullheight'}, [
                m('div', {class:'hero-head'}, [
                    m('header', {class:'navbar'}, [
                        m('div', {class:'container'}, [
                            m('div', {class:'navbar-brand'}, [
                                m('h1', {class:'navbar-item title', style:'margin-top:auto; margin-bottom:auto'}, "TinyInsta"),
                                m('div', {
                                    class:'navbar-item g-signin2',
                                    style:'margin-top:auto; margin-bottom:auto',
                                    'data-theme':'dark',
                                    'data-onsuccess':'onSignIn'
                                })
                            ])
                        ])
                    ])
                ]),
                m('div', {class:'hero-body'}, [
                    m('div', {class:'container has-text-centered'}, [
                        m('h1', {class:'title', style:'width:50%; margin-left:auto; margin-right:auto'},
                            "Pour utiliser TinyInsta il est nécessaire de se connecter avec son compte Google")
                    ])
                ])
            ])
        }
    }

    let PostMessage = {
        content:"",
        image:"",
        view: function() {
            return m('div', {class:'container box block'}, [
                m('article', {class:'media'}, [
                    m('div', {class:'media-content'}, [
                        m('form', {name:'f'}, [
                            m('div', {class:'field'}, [
                                m('p', {class:'control'}, [
                                    m('textarea', {
                                        class:'textarea',
                                        placeholder:'Écrire un message',
                                        oninput: PostMessage.updateContent,
                                        value: PostMessage.content
                                    })
                                ])
                            ]),
                            m('div', {class:'field'}, [
                                m('p', {class:'control'}, [
                                    m('input', {
                                        class:'input',
                                        type:'text',
                                        placeholder:'URL image',
                                        oninput: PostMessage.updateImage,
                                        value: PostMessage.image})
                                ])
                            ]),
                            m('nav', {class:'level'}, [
                                m('div', {class:'level-left'}, [
                                    m('div', {class:'level-item'}, [
                                        m('a', {onclick:PostMessage.postMessage ,class:'button is-info is-light'}, 'Envoyer')
                                    ])
                                ])
                            ])
                        ])
                    ])
                ])
            ])
        },
        updateContent: function (text) {
            PostMessage.content = text.target.value;
        },
        updateImage: function (url) {
            PostMessage.image = url.target.value;
        },
        postMessage: function() {
            Profile.postMessage(PostMessage.content, PostMessage.image);
        }
    }

    class Message {
        constructor(nameSender, imageSender, imageMessage, content, nbLike) {
            this.nameSender = nameSender;
            this.imageSender = imageSender;
            this.imageMessage = imageMessage;
            this.content = content;
            this.nbLike = nbLike;
        }

        view() {
            return m('div', {class:'container box block'}, [
                m('article', {class:'media'}, [
                    m('figure', {class:'media-left'}, [
                        m('img', {src:this.imageSender, class:'image is-64x64', style:'border-radius:50%'})
                    ]),
                    m('div', {class:'media-content'}, [
                        m('div', {class:'field'}, [
                            m('p', {class:'control'}, [
                                m('strong', this.nameSender),
                                m('br'),
                                m('p', this.content)
                            ])
                        ]),
                        m('div', {class:'field'}, [
                            m('img', {src:this.imageMessage, class:'image'})
                        ]),
                        m('nav', {class:'level'}, [
                            m('div', {class:'level-left'}, [
                                m('p', {style:'margin-top:auto; margin-bottom:auto; margin-right:5px; font-size:15px'}, this.nbLike),
                                m('a', {class:'level-item', onclick:this.like, style:'margin-top:auto; margin-bottom:auto'}, [
                                    m('span', {class:'icon is-small'}, [
                                        m('i', {class:'fas fa-heart'})
                                    ])
                                ])
                            ])
                        ])
                    ]),
                    m('div', {class:'media-right'}, [
                        m('button', {class:'button is-info is-light is-small', onclick:this.follow}, "Follow")
                    ])
                ])
            ])
        }

        follow() {
            console.log(Profile.follow(Profile.ID));
        }

        like() {
            console.log("Un like s'est ajouté");
        }
    }

    const image = 'https://lh3.googleusercontent.com/a-/AOh14Gi4nloDhM3cflgm1AbQH4fE6dDLLgZlm-GjBjy1=s96-c';
    let message = new Message("Nom du sender", image, image, "Contenu du message", 10);

    let TimeLine = {
        listItems:[
            m(PostMessage),
            m(message),
            m(message),
            m(message),
            m(message),
            m(message),
            m('button', {class:'button is-info is-outlined', onclick:Profile.next}, "Afficher plus de messages")
        ],
        view: function() {
            return m('div', TimeLine.listItems)
        }
    }

    m.route(document.body, "/secret", {
        "/secret": { onmatch: function() {
                if (Profile.ID==="") {m.route.set("/login")}
                else return Profile
            }},
        "/login": Login
    })

</script>
</body>
</html>


